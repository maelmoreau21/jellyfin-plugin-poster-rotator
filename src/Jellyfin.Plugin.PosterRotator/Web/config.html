<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Poster Rotator</title>
  <style>
    .fieldDescription { font-size: 0.85em; color: #999; margin-top: 4px; }
    .checkboxContainer-withDescription { margin-top: 16px; }
    .inputContainer { margin-top: 12px; }
  </style>
</head>
<body>
  <div id="PosterRotatorConfigPage"
       data-role="page"
       class="page type-interior pluginConfigurationPage"
       data-require="emby-input,emby-button,emby-checkbox">

    <div data-role="content">
      <div class="content-primary">
        <form id="PosterRotatorConfigForm">

          <!-- SECTION: Biblioth√®ques -->
          <h2>Biblioth√®ques √† affecter</h2>

          <!-- Container pour les r√®gles de librairie (rempli par le JS) -->
          <div id="LibraryRulesContainer" style="margin-top:12px; margin-bottom:14px;"></div>

          <!-- SECTION: Param√®tres de rotation -->
          <h2>Param√®tres de rotation</h2>

          <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="PoolSize">Taille du pool (affiches par film)</label>
            <input id="PoolSize" type="number" min="1" max="20" is="emby-input" value="5" />
            <div class="fieldDescription">Nombre d'affiches √† conserver par film</div>
          </div>

          <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="MinHoursBetweenSwitches">Heures minimum entre les changements</label>
            <input id="MinHoursBetweenSwitches" type="number" min="1" is="emby-input" value="24" />
            <div class="fieldDescription">Dur√©e minimale avant de changer l'affiche (en heures)</div>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription">
            <label class="emby-checkbox-label">
              <input id="SequentialRotation" type="checkbox" is="emby-checkbox" />
              <span>Rotation s√©quentielle</span>
            </label>
            <div class="fieldDescription">Si d√©coch√©: rotation al√©atoire</div>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription">
            <label class="emby-checkbox-label">
              <input id="LockImagesAfterFill" type="checkbox" is="emby-checkbox" />
              <span>Verrouiller apr√®s remplissage du pool</span>
            </label>
            <div class="fieldDescription">Emp√™che les mises √† jour de m√©tadonn√©es de modifier le pool</div>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription">
            <label class="emby-checkbox-label">
              <input id="EnableSeasonPosters" type="checkbox" is="emby-checkbox" />
              <span>Inclure les saisons</span>
            </label>
            <div class="fieldDescription">Ajoute les affiches des saisons √† la rotation (d√©sactiv√© par d√©faut)</div>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription">
            <label class="emby-checkbox-label">
              <input id="EnableEpisodePosters" type="checkbox" is="emby-checkbox" />
              <span>Inclure les √©pisodes</span>
            </label>
            <div class="fieldDescription">Ajoute les miniatures des √©pisodes √† la rotation (d√©sactiv√© par d√©faut)</div>
          </div>

          <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom:14px;">
            <label class="emby-checkbox-label">
              <input id="TriggerLibraryScanAfterRotation" type="checkbox" is="emby-checkbox" />
              <span>D√©clencher un scan de la biblioth√®que apr√®s rotation</span>
            </label>
            <div class="fieldDescription">Optionnel et co√ªteux : force un scan pour que Jellyfin r√©indexe les images (activ√© par d√©faut)</div>
          </div>

          <!-- SECTION: Param√®tres avanc√©s -->
          <h2>Param√®tres avanc√©s</h2>

          <div class="inputContainer">
            <label class="inputLabel inputLabelUnfocused" for="ExtraPosterPatterns">Motifs suppl√©mentaires (s√©par√©s par virgule)</label>
            <input id="ExtraPosterPatterns" type="text" is="emby-input" placeholder="folder.jpg, alt-*.png" />
          </div>

          <!-- BOUTON SAVE -->
          <div style="margin-top: 30px;">
            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
              <span>Enregistrer</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="text/javascript">
      (function () {
        var pluginId = '7f6eea8b-0e9c-4cbd-9d2a-31f9a37ce2b7';

        function byId(id) { return document.getElementById(id); }

        function createLibraryCheckbox(rule) {
          var div = document.createElement('div');
          div.className = 'checkboxContainer checkboxContainer-withDescription';
          div.style.marginBottom = '8px';

          var label = document.createElement('label');
          label.className = 'emby-checkbox-label';

          var checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.setAttribute('is', 'emby-checkbox');
          checkbox.checked = !!(rule && rule.Enabled);
          checkbox.dataset.libraryName = (rule && rule.Name) ? rule.Name : '';

          var span = document.createElement('span');
          span.textContent = (rule && rule.Name) ? rule.Name : '(sans nom)';

          label.appendChild(checkbox);
          label.appendChild(span);
          div.appendChild(label);

          return div;
        }

        function addLibraryCheckboxToContainer(name, checked) {
          var rule = { Name: name, Enabled: !!checked };
          return createLibraryCheckbox(rule);
        }

        function load() {
          Dashboard.showLoadingMsg();
          ApiClient.getPluginConfiguration(pluginId)
            .then(function (cfg) {
              cfg = cfg || {};
              if (byId('PoolSize')) byId('PoolSize').value = (cfg.PoolSize ?? 5);
              if (byId('MinHoursBetweenSwitches')) byId('MinHoursBetweenSwitches').value = (cfg.MinHoursBetweenSwitches ?? 24);
              if (byId('SequentialRotation')) byId('SequentialRotation').checked = !!cfg.SequentialRotation;
              if (byId('LockImagesAfterFill')) byId('LockImagesAfterFill').checked = !!cfg.LockImagesAfterFill;
              if (byId('TriggerLibraryScanAfterRotation')) byId('TriggerLibraryScanAfterRotation').checked = (cfg.TriggerLibraryScanAfterRotation === undefined ? true : !!cfg.TriggerLibraryScanAfterRotation);

              if (byId('EnableSeasonPosters')) byId('EnableSeasonPosters').checked = !!cfg.EnableSeasonPosters;
              if (byId('EnableEpisodePosters')) byId('EnableEpisodePosters').checked = !!cfg.EnableEpisodePosters;

              // ExtraPosterPatterns may be stored as an array; guard accordingly
              try {
                var extraArr = Array.isArray(cfg.ExtraPosterPatterns) ? cfg.ExtraPosterPatterns : (cfg.ExtraPosterPatterns ? cfg.ExtraPosterPatterns : []);
                if (byId('ExtraPosterPatterns')) byId('ExtraPosterPatterns').value = (extraArr || []).join(', ');
              } catch (e) {
                if (byId('ExtraPosterPatterns')) byId('ExtraPosterPatterns').value = '';
              }

              // Load libraries from saved configuration: show LibraryRules and manual roots
              console.log('PosterRotator: saved LibraryRules from server:', cfg.LibraryRules);
              var container = byId('LibraryRulesContainer');
              if (container) {
                container.innerHTML = '';
                var existing = (cfg.LibraryRules || []);
                if (existing.length > 0) {
                  existing.forEach(function (rule) {
                    container.appendChild(addLibraryCheckboxToContainer(rule.Name, !!rule.Enabled));
                  });
                }
              }
              // --- auto-fill LibraryRules from server if none saved (improved with debug) ---
              (function fillLibrariesIfEmpty() {
                var container = byId('LibraryRulesContainer');
                if (!container) {
                  console.warn('PosterRotator: #LibraryRulesContainer introuvable dans le DOM.');
                  return;
                }

                var existing = (cfg.LibraryRules || []);
                if (existing.length > 0) {
                  console.log('PosterRotator: LibraryRules d√©j√† pr√©sentes dans cfg, on ne remplace pas.');
                  return; // on garde ce qui est sauvegard√©
                }

                console.log('PosterRotator: tentative de r√©cup√©ration des VirtualFolders du serveur...');

                function getVirtualFolders() {
                  if (typeof ApiClient !== 'undefined' && ApiClient.get) {
                    // üîß Correction : on lit le JSON de la r√©ponse
                    return ApiClient.get('/Library/VirtualFolders').then(r => r.json());
                  }
                  // fallback direct
                  return fetch('/Library/VirtualFolders', { credentials: 'same-origin' })
                    .then(function (r) {
                      if (!r.ok) throw new Error('HTTP ' + r.status);
                      return r.json();
                    });
                }

                getVirtualFolders()
                  .then(function (res) {
                    console.log('PosterRotator: r√©ponse VirtualFolders re√ßue :', res);
                    var folders = Array.isArray(res) ? res : (res.Items || []);
                    if (!folders || folders.length === 0) {
                      container.innerHTML = '<div class="fieldDescription">Aucune biblioth√®que d√©tect√©e. (r√©ponse vide)</div>';
                      return;
                    }

                    container.innerHTML = '';
                    folders.forEach(function (f) {
                      var name = f.Name || f.DisplayName || (f.Path ? f.Path.split(/[\\/]/).pop() : 'Unknown');
                      container.appendChild(addLibraryCheckboxToContainer(name, true));
                    });

                    console.log('PosterRotator: biblioth√®ques ajout√©es au DOM:', folders.map(function(f){return f.Name || f.DisplayName;}));
                  })
                  .catch(function (err) {
                    console.error('PosterRotator: erreur chargement biblioth√®ques:', err);
                    // Afficher plus de d√©tails si possible
                    if (err && err.status) {
                      container.innerHTML = '<div class="fieldDescription" style="color:#c00">Impossible de charger les biblioth√®ques (HTTP ' + err.status + ')</div>';
                    } else {
                      container.innerHTML = '<div class="fieldDescription" style="color:#c00">Impossible de charger les biblioth√®ques (voir console pour d√©tails)</div>';
                    }
                  });
              })();

              // Fill manual roots textarea
              try {
                var rootsText = '';
                if (Array.isArray(cfg.ManualLibraryRoots)) rootsText = cfg.ManualLibraryRoots.join('\n');
                if (byId('ManualLibraryRoots')) byId('ManualLibraryRoots').value = rootsText;
              } catch (e) { console.error(e); }
            })
            .catch(function (err) {
              console.error('PosterRotator load error:', err);
              alert('Erreur lors du chargement de la configuration. Voir la console.');
            })
            .finally(function () { Dashboard.hideLoadingMsg(); });
        }

        function save(e) {
          e && e.preventDefault();
          Dashboard.showLoadingMsg();

          ApiClient.getPluginConfiguration(pluginId)
            .then(function (cfg) {
              cfg = cfg || {};

              // Lecture et validation du PoolSize
              var rawValue = byId('PoolSize')?.value;
              console.log('[PosterRotator] PoolSize input value:', rawValue);

              var n = parseInt(rawValue, 10);

              if (isNaN(n) || n < 1) {
                alert("Valeur de PoolSize invalide. Entrez un nombre sup√©rieur ou √©gal √† 1.");
                Dashboard.hideLoadingMsg();
                return; // stop la sauvegarde
              }

              cfg.PoolSize = n;

              // V√©rification avant envoi
              console.log('[PosterRotator] PoolSize enregistr√© dans cfg:', cfg.PoolSize);


              var h = parseInt((byId('MinHoursBetweenSwitches')?.value || '24'), 10);
              cfg.MinHoursBetweenSwitches = (isNaN(h) || h < 1) ? 24 : h;

              // Booleans
              cfg.SequentialRotation = !!(byId('SequentialRotation') && byId('SequentialRotation').checked);
              cfg.LockImagesAfterFill = !!(byId('LockImagesAfterFill') && byId('LockImagesAfterFill').checked);
              cfg.TriggerLibraryScanAfterRotation = !!(byId('TriggerLibraryScanAfterRotation') && byId('TriggerLibraryScanAfterRotation').checked);
              cfg.EnableSeasonPosters = !!(byId('EnableSeasonPosters') && byId('EnableSeasonPosters').checked);
              cfg.EnableEpisodePosters = !!(byId('EnableEpisodePosters') && byId('EnableEpisodePosters').checked);

              // Patterns
              var extra = (byId('ExtraPosterPatterns')?.value || '');
              cfg.ExtraPosterPatterns = extra.split(',').map(function (s) { return s.trim(); }).filter(Boolean);

              // Libraries (saved rules)
              var libraryCheckboxes = document.querySelectorAll('#LibraryRulesContainer input[type="checkbox"]');
              cfg.LibraryRules = [];
              libraryCheckboxes.forEach(function (cb) {
                var name = cb.dataset.libraryName || (cb.parentElement ? (cb.parentElement.querySelector('span')?.textContent) : null) || 'Unknown';
                cfg.LibraryRules.push({
                  Name: name,
                  Enabled: !!cb.checked
                });
              });

              // Manual library roots (one per line)
              try {
                var rootsVal = (byId('ManualLibraryRoots')?.value || '').split(/\r?\n/).map(function(s){return s.trim();}).filter(Boolean);
                cfg.ManualLibraryRoots = rootsVal;
              } catch (e) { cfg.ManualLibraryRoots = []; }

              console.log('[PosterRotator] Configuration envoy√©e au serveur:', JSON.stringify(cfg, null, 2));
              return ApiClient.updatePluginConfiguration(pluginId, cfg);
            })
            .then(function (result) { Dashboard.processPluginConfigurationUpdateResult(result); })
            .catch(function (err) {
              console.error('PosterRotator save error:', err);
              alert('Erreur lors de la sauvegarde. Voir la console.');
            })
            .finally(function () { Dashboard.hideLoadingMsg(); });

          return false;
        }

        var root = byId('PosterRotatorConfigPage');
        var form = byId('PosterRotatorConfigForm');

        if (root) {
          root.addEventListener('pageshow', load);
          root.addEventListener('viewshow', load);
        }
        if (form) {
          form.addEventListener('submit', save);
        }
      })();
    </script>
  </div>
</body>
</html>
