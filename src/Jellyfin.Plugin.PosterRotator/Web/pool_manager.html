<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>Pool Manager</title>
    <style>
        :root {
            --bg: #101016;
            --surface: #1a1a24;
            --surface-hover: #242430;
            --border: #2a2a38;
            --accent: #00a4dc;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e8e8e8;
            --text-muted: #888;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        /* === LAYOUT === */
        .pm-app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === HEADER === */
        .pm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .pm-header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .pm-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .pm-stat strong {
            color: var(--accent);
        }

        .pm-stat.warn strong {
            color: var(--warning);
        }

        .pm-btn {
            padding: 10px 18px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .pm-btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }

        .pm-btn-danger {
            border-color: #5c2020;
            color: #f87171;
        }

        .pm-btn-danger:hover {
            background: #5c2020;
        }

        .pm-btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* === SEARCH BAR === */
        .pm-search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .pm-search {
            flex: 1;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .pm-search:focus {
            outline: none;
            border-color: var(--accent);
        }

        .pm-filters {
            display: flex;
            gap: 8px;
        }

        .pm-filter {
            padding: 10px 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
        }

        .pm-filter:hover {
            background: var(--surface-hover);
        }

        .pm-filter.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* === ACCORDION LIST === */
        .pm-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* === ACCORDION ITEM === */
        .pm-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .pm-item:hover {
            border-color: #3a3a48;
        }

        .pm-item.open {
            border-color: var(--accent);
        }

        /* Header Row */
        .pm-item-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            gap: 16px;
        }

        .pm-item-header:hover {
            background: var(--surface-hover);
        }

        .pm-item-expand {
            font-size: 14px;
            color: var(--text-muted);
            transition: transform 0.2s;
            width: 20px;
        }

        .pm-item.open .pm-item-expand {
            transform: rotate(90deg);
            color: var(--accent);
        }

        .pm-item-name {
            flex: 1;
            font-size: 15px;
            font-weight: 600;
        }

        .pm-item-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Health Indicator */
        .pm-health {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .pm-health.ok {
            background: #1a3d1a;
            color: var(--success);
        }

        .pm-health.low {
            background: #3d2a1a;
            color: var(--warning);
        }

        .pm-health.empty {
            background: #3d1a1a;
            color: var(--danger);
        }

        .pm-type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pm-type-badge.movie {
            background: #4c1d95;
            color: #c4b5fd;
        }

        .pm-type-badge.series {
            background: #0e4d5f;
            color: #67e8f9;
        }

        /* Content Panel (Images) */
        .pm-item-content {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid var(--border);
        }

        .pm-item.open .pm-item-content {
            display: block;
        }

        /* Action Bar */
        .pm-actions {
            display: flex;
            gap: 10px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .pm-actions .pm-btn {
            padding: 8px 14px;
            font-size: 12px;
        }

        /* Images Grid */
        .pm-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .pm-img {
            position: relative;
            aspect-ratio: 2/3;
            border-radius: 6px;
            overflow: hidden;
            background: #0a0a0f;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .pm-img:hover {
            border-color: var(--accent);
            transform: scale(1.02);
        }

        .pm-img.current {
            border-color: var(--success);
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.4);
        }

        .pm-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pm-img-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: var(--success);
            color: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .pm-img-del {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 22px;
            height: 22px;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .pm-img:hover .pm-img-del {
            opacity: 1;
        }

        /* Add Image Zone */
        .pm-add-zone {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }

        .pm-add-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .pm-add-tab {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
        }

        .pm-add-tab.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .pm-add-content {
            min-height: 80px;
        }

        .pm-remote-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
        }

        .pm-remote-img {
            aspect-ratio: 2/3;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }

        .pm-remote-img:hover {
            border-color: var(--accent);
        }

        .pm-remote-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pm-remote-add {
            position: absolute;
            inset: 0;
            background: rgba(0, 164, 220, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .pm-remote-img:hover .pm-remote-add {
            opacity: 1;
        }

        .pm-dropzone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pm-dropzone:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .pm-dropzone input {
            display: none;
        }

        /* Loading & Empty States */
        .pm-loading,
        .pm-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
            gap: 10px;
        }

        .pm-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="PoolManagerPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary pm-app">

                <!-- Header -->
                <div class="pm-header">
                    <h1>üé® Pool Manager</h1>
                    <div class="pm-stats" id="stats">Chargement...</div>
                    <div style="display:flex;gap:10px;">
                        <button class="pm-btn pm-btn-danger" id="btnCleanup">üóëÔ∏è Orphelins</button>
                        <a href="#!/configurationpage?name=Poster%20Rotator" class="pm-btn">‚Üê Retour</a>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="pm-search-bar">
                    <input type="text" class="pm-search" id="search"
                        placeholder="üîç Rechercher un film ou une s√©rie..." />
                    <div class="pm-filters">
                        <button class="pm-filter active" data-f="">Tous</button>
                        <button class="pm-filter" data-f="Movie">Films</button>
                        <button class="pm-filter" data-f="Series">S√©ries</button>
                    </div>
                </div>

                <!-- Accordion List -->
                <div class="pm-list" id="list">
                    <div class="pm-loading">
                        <div class="pm-spinner"></div>Chargement...
                    </div>
                </div>

            </div>
        </div>

        <script type="text/javascript">
            (function () {
                var pools = [], openId = null, filter = '';
                var $ = function (id) { return document.getElementById(id); };
                var esc = function (s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; };

                function api(m, u, d) {
                    return new Promise(function (r, j) {
                        ApiClient.ajax({
                            type: m,
                            url: ApiClient.getUrl(u),
                            data: d ? JSON.stringify(d) : null,
                            contentType: 'application/json',
                            dataType: 'json'
                        }).then(r, j);
                    });
                }

                function loadStats() {
                    api('GET', 'PosterRotator/Stats').then(function (s) {
                        var warn = s.OrphanedPools > 0 ? ' warn' : '';
                        $('stats').innerHTML =
                            '<div class="pm-stat"><strong>' + s.TotalPools + '</strong> pools</div>' +
                            '<div class="pm-stat"><strong>' + s.TotalImages + '</strong> images</div>' +
                            '<div class="pm-stat"><strong>' + (s.TotalSizeFormatted || '0 B') + '</strong></div>' +
                            '<div class="pm-stat' + warn + '"><strong>' + s.OrphanedPools + '</strong> orphelins</div>';
                    });
                }

                function loadPools() {
                    api('GET', 'PosterRotator/Items').then(function (p) {
                        pools = p || [];
                        renderList();
                    });
                }

                function getHealthClass(count) {
                    if (count === 0) return 'empty';
                    if (count < 3) return 'low';
                    return 'ok';
                }

                function getHealthLabel(count) {
                    if (count === 0) return '‚ö† Vide';
                    if (count < 3) return '‚ö† ' + count;
                    return '‚úì ' + count;
                }

                function renderList() {
                    var q = ($('search').value || '').toLowerCase();
                    var f = pools.filter(function (p) {
                        return (!filter || p.ItemType === filter) && (!q || (p.ItemName || '').toLowerCase().indexOf(q) >= 0);
                    });

                    if (!f.length) {
                        $('list').innerHTML = '<div class="pm-empty">Aucun pool trouv√©</div>';
                        return;
                    }

                    var html = '';
                    f.forEach(function (p) {
                        var isOpen = openId === p.ItemId;
                        var count = p.Images ? p.Images.length : 0;
                        var health = getHealthClass(count);
                        var type = (p.ItemType || 'movie').toLowerCase();

                        html += '<div class="pm-item' + (isOpen ? ' open' : '') + '" data-id="' + p.ItemId + '">';

                        // Header
                        html += '<div class="pm-item-header">';
                        html += '<span class="pm-item-expand">‚ñ∂</span>';
                        html += '<span class="pm-item-name">' + esc(p.ItemName) + '</span>';
                        html += '<div class="pm-item-meta">';
                        html += '<span class="pm-health ' + health + '">' + getHealthLabel(count) + '</span>';
                        html += '<span>' + esc(p.TotalSizeFormatted) + '</span>';
                        html += '<span class="pm-type-badge ' + type + '">' + esc(p.ItemType) + '</span>';
                        html += '</div>';
                        html += '</div>';

                        // Content (will be loaded on click)
                        html += '<div class="pm-item-content" id="content-' + p.ItemId + '">';
                        if (isOpen) {
                            html += '<div class="pm-loading"><div class="pm-spinner"></div></div>';
                        }
                        html += '</div>';

                        html += '</div>';
                    });

                    $('list').innerHTML = html;

                    // Bind clicks
                    document.querySelectorAll('.pm-item-header').forEach(function (el) {
                        el.onclick = function () {
                            var id = el.parentElement.dataset.id;
                            toggleItem(id);
                        };
                    });

                    // Load open item
                    if (openId) loadItemContent(openId);
                }

                function toggleItem(id) {
                    if (openId === id) {
                        openId = null;
                    } else {
                        openId = id;
                    }
                    renderList();
                }

                function loadItemContent(id) {
                    var container = $('content-' + id);
                    if (!container) return;

                    container.innerHTML = '<div class="pm-loading"><div class="pm-spinner"></div></div>';

                    api('GET', 'PosterRotator/Pool/' + id).then(function (pool) {
                        renderItemContent(container, pool);
                    });
                }

                function renderItemContent(container, pool) {
                    var html = '';

                    // Actions
                    html += '<div class="pm-actions">';
                    html += '<button class="pm-btn pm-btn-primary" data-action="rotate" data-id="' + pool.ItemId + '">üîÑ Forcer rotation</button>';
                    html += '</div>';

                    // Images Grid
                    if (!pool.Images || !pool.Images.length) {
                        html += '<div class="pm-empty">Aucune image dans ce pool</div>';
                    } else {
                        html += '<div class="pm-images">';
                        pool.Images.forEach(function (img) {
                            var cur = img.IsCurrent ? ' current' : '';
                            var url = ApiClient.getUrl(img.Url);
                            html += '<div class="pm-img' + cur + '">';
                            if (img.IsCurrent) html += '<div class="pm-img-badge">Actif</div>';
                            html += '<img src="' + url + '" loading="lazy" />';
                            html += '<button class="pm-img-del" data-file="' + esc(img.FileName) + '" data-id="' + pool.ItemId + '">√ó</button>';
                            html += '</div>';
                        });
                        html += '</div>';
                    }

                    // Add Zone
                    html += '<div class="pm-add-zone">';
                    html += '<div class="pm-add-tabs">';
                    html += '<button class="pm-add-tab active" data-tab="search" data-id="' + pool.ItemId + '">üîç Chercher</button>';
                    html += '<button class="pm-add-tab" data-tab="upload" data-id="' + pool.ItemId + '">üì§ Importer</button>';
                    html += '</div>';
                    html += '<div class="pm-add-content" id="add-' + pool.ItemId + '"></div>';
                    html += '</div>';

                    container.innerHTML = html;

                    // Bind actions
                    container.querySelectorAll('[data-action="rotate"]').forEach(function (btn) {
                        btn.onclick = function () { forceRotate(btn.dataset.id); };
                    });

                    container.querySelectorAll('.pm-img-del').forEach(function (btn) {
                        btn.onclick = function (e) { e.stopPropagation(); deleteImage(btn.dataset.id, btn.dataset.file); };
                    });

                    container.querySelectorAll('.pm-add-tab').forEach(function (btn) {
                        btn.onclick = function () {
                            container.querySelectorAll('.pm-add-tab').forEach(function (t) { t.classList.remove('active'); });
                            btn.classList.add('active');
                            if (btn.dataset.tab === 'search') searchImages(btn.dataset.id);
                            else renderUpload(btn.dataset.id);
                        };
                    });

                    // Load search by default
                    searchImages(pool.ItemId);
                }

                function forceRotate(id) {
                    api('POST', 'PosterRotator/Pool/' + id + '/Rotate').then(function () {
                        loadItemContent(id);
                        loadStats();
                    }).catch(function () {
                        alert('√âchec de la rotation');
                    });
                }

                function deleteImage(id, file) {
                    if (!confirm('Supprimer cette image ?')) return;
                    api('DELETE', 'PosterRotator/Pool/' + id + '/' + encodeURIComponent(file)).then(function () {
                        loadItemContent(id);
                        loadStats();
                        loadPools();
                    });
                }

                function searchImages(id) {
                    var container = $('add-' + id);
                    if (!container) return;

                    container.innerHTML = '<div class="pm-loading"><div class="pm-spinner"></div></div>';

                    api('GET', 'PosterRotator/Search/' + id).then(function (imgs) {
                        if (!imgs || !imgs.length) {
                            container.innerHTML = '<div class="pm-empty">Aucune image trouv√©e</div>';
                            return;
                        }

                        var html = '<div class="pm-remote-grid">';
                        imgs.slice(0, 20).forEach(function (img) {
                            html += '<div class="pm-remote-img" data-url="' + esc(img.Url) + '" data-id="' + id + '">';
                            html += '<img src="' + esc(img.ThumbnailUrl || img.Url) + '" loading="lazy" />';
                            html += '<div class="pm-remote-add">+</div>';
                            html += '</div>';
                        });
                        html += '</div>';
                        container.innerHTML = html;

                        container.querySelectorAll('.pm-remote-img').forEach(function (el) {
                            el.onclick = function () { addFromUrl(el.dataset.id, el.dataset.url); };
                        });
                    }).catch(function () {
                        container.innerHTML = '<div class="pm-empty">Erreur de recherche</div>';
                    });
                }

                function addFromUrl(id, url) {
                    api('POST', 'PosterRotator/Pool/' + id + '/AddFromUrl', { Url: url }).then(function () {
                        loadItemContent(id);
                        loadStats();
                        loadPools();
                    });
                }

                function renderUpload(id) {
                    var container = $('add-' + id);
                    if (!container) return;

                    container.innerHTML =
                        '<div class="pm-dropzone" id="dz-' + id + '">' +
                        'üì§ Glissez des images ici ou cliquez' +
                        '<input type="file" id="fi-' + id + '" accept="image/*" multiple />' +
                        '</div>';

                    var dz = $('dz-' + id), fi = $('fi-' + id);
                    dz.onclick = function () { fi.click(); };
                    fi.onchange = function () { uploadFiles(id, fi.files); };
                    dz.ondragover = function (e) { e.preventDefault(); dz.style.borderColor = 'var(--accent)'; };
                    dz.ondragleave = function () { dz.style.borderColor = ''; };
                    dz.ondrop = function (e) { e.preventDefault(); uploadFiles(id, e.dataTransfer.files); };
                }

                function uploadFiles(id, files) {
                    if (!files.length) return;
                    var n = files.length;

                    Array.from(files).forEach(function (f) {
                        var fd = new FormData();
                        fd.append('file', f);

                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', ApiClient.getUrl('PosterRotator/Pool/' + id));
                        xhr.setRequestHeader('X-Emby-Token', ApiClient.accessToken());
                        xhr.onload = function () {
                            if (--n === 0) {
                                loadItemContent(id);
                                loadStats();
                                loadPools();
                            }
                        };
                        xhr.send(fd);
                    });
                }

                // Filter & Search
                $('search').oninput = renderList;
                document.querySelectorAll('.pm-filter').forEach(function (btn) {
                    btn.onclick = function () {
                        document.querySelectorAll('.pm-filter').forEach(function (b) { b.classList.remove('active'); });
                        btn.classList.add('active');
                        filter = btn.dataset.f;
                        renderList();
                    };
                });

                // Cleanup
                $('btnCleanup').onclick = function () {
                    if (!confirm('Supprimer les pools orphelins ?')) return;
                    api('POST', 'PosterRotator/Cleanup').then(function (r) {
                        alert(r.message || 'Nettoyage termin√©');
                        loadStats();
                        loadPools();
                    });
                };

                // Init
                var page = $('PoolManagerPage');
                page.addEventListener('viewshow', function () { loadStats(); loadPools(); });
                page.addEventListener('pageshow', function () { loadStats(); loadPools(); });
            })();
        </script>
    </div>
</body>

</html>