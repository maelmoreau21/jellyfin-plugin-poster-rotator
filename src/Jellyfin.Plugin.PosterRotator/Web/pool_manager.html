<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Pool Manager</title>
  <style>
    /* === DESIGN SYSTEM === */
    :root {
      --bg: #181820;
      --surface: #22222e;
      --surface-hover: #2c2c3a;
      --border: #333346;
      --accent: #00a4dc;
      --accent-dim: rgba(0,164,220,0.15);
      --green: #22c55e;
      --green-dim: rgba(34,197,94,0.15);
      --orange: #f59e0b;
      --orange-dim: rgba(245,158,11,0.15);
      --red: #ef4444;
      --red-dim: rgba(239,68,68,0.15);
      --text: #eaeaea;
      --text2: #999;
      --radius: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); }

    /* === LAYOUT === */
    .pm { max-width: 1100px; margin: 0 auto; padding: 24px; }

    /* === HEADER === */
    .pm-head { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
    .pm-head h1 { font-size: 22px; font-weight: 700; flex: 1; }
    .pm-head-stats { display: flex; gap: 18px; font-size: 13px; color: var(--text2); }
    .pm-head-stats b { color: var(--accent); font-weight: 600; }
    .pm-head-stats .warn b { color: var(--orange); }
    .pm-head-actions { display: flex; gap: 8px; }

    /* === BUTTONS === */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px;
      background: var(--surface); color: var(--text); cursor: pointer;
      font-size: 13px; font-weight: 500; text-decoration: none; transition: all .15s;
    }
    .btn:hover { background: var(--surface-hover); border-color: var(--accent); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-accent { background: var(--accent); border-color: var(--accent); color: #fff; }
    .btn-accent:hover { background: #0090c0; }
    .btn-red { border-color: #5c2020; color: #f87171; }
    .btn-red:hover { background: #3d1a1a; }

    /* === SEARCH === */
    .pm-search { display: flex; gap: 10px; margin-bottom: 20px; }
    .pm-search input {
      flex: 1; padding: 10px 14px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px; outline: none;
    }
    .pm-search input:focus { border-color: var(--accent); }
    .pm-search .filters { display: flex; gap: 6px; }
    .pm-search .fil {
      padding: 8px 14px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text2); cursor: pointer; font-size: 13px;
    }
    .pm-search .fil:hover { background: var(--surface-hover); }
    .pm-search .fil.on { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* === ACCORDION === */
    .acc { display: flex; flex-direction: column; gap: 6px; }

    .acc-item {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden; transition: border-color .15s;
    }
    .acc-item.open { border-color: var(--accent); }

    .acc-head {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 18px; cursor: pointer; transition: background .12s;
    }
    .acc-head:hover { background: var(--surface-hover); }

    .acc-arrow { font-size: 12px; color: var(--text2); transition: transform .2s; width: 16px; }
    .acc-item.open .acc-arrow { transform: rotate(90deg); color: var(--accent); }

    .acc-name { flex: 1; font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .acc-meta { display: flex; align-items: center; gap: 12px; font-size: 12px; color: var(--text2); flex-shrink: 0; }

    /* Health badge */
    .hp { padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; }
    .hp-ok { background: var(--green-dim); color: var(--green); }
    .hp-low { background: var(--orange-dim); color: var(--orange); }
    .hp-empty { background: var(--red-dim); color: var(--red); }

    /* Type badge */
    .tp { padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
    .tp-movie { background: #4c1d95; color: #c4b5fd; }
    .tp-series { background: #0e4d5f; color: #67e8f9; }
    .tp-season { background: #3d3d00; color: #fef08a; }

    /* Body panel */
    .acc-body { display: none; padding: 0 18px 18px; border-top: 1px solid var(--border); }
    .acc-item.open .acc-body { display: block; }

    /* === TOOLBAR === */
    .toolbar { display: flex; gap: 8px; padding: 14px 0 14px; }

    /* === IMAGE GRID === */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
    .card {
      position: relative; aspect-ratio: 2/3; border-radius: 8px; overflow: hidden;
      background: #111; border: 2px solid transparent; cursor: default; transition: all .12s;
    }
    .card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .card.active { border-color: var(--green); box-shadow: 0 0 16px rgba(34,197,94,.35); }
    .card img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .card-badge {
      position: absolute; top: 5px; left: 5px;
      background: var(--green); color: #fff; padding: 2px 8px;
      border-radius: 8px; font-size: 9px; font-weight: 800; text-transform: uppercase;
    }
    .card-del {
      position: absolute; top: 5px; right: 5px; width: 22px; height: 22px;
      background: var(--red); border: none; border-radius: 50%; color: #fff;
      font-size: 13px; cursor: pointer; opacity: 0; transition: opacity .12s;
      display: flex; align-items: center; justify-content: center;
    }
    .card:hover .card-del { opacity: 1; }

    /* === ADD ZONE === */
    .add-zone { margin-top: 14px; background: var(--bg); border-radius: 8px; padding: 14px; }
    .add-tabs { display: flex; gap: 6px; margin-bottom: 10px; }
    .add-tab {
      padding: 6px 14px; background: transparent; border: 1px solid var(--border);
      border-radius: 4px; color: var(--text2); cursor: pointer; font-size: 12px;
    }
    .add-tab.on { background: var(--accent); color: #fff; border-color: var(--accent); }
    .add-body { min-height: 60px; }

    /* Remote images */
    .r-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 6px; }
    .r-card {
      position: relative; aspect-ratio: 2/3; border-radius: 5px; overflow: hidden;
      cursor: pointer; border: 2px solid transparent; transition: border-color .12s;
    }
    .r-card:hover { border-color: var(--accent); }
    .r-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .r-plus {
      position: absolute; inset: 0; background: rgba(0,164,220,.75);
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: #fff; opacity: 0; transition: opacity .12s;
    }
    .r-card:hover .r-plus { opacity: 1; }

    /* Dropzone */
    .dz {
      border: 2px dashed var(--border); border-radius: 8px; padding: 24px;
      text-align: center; color: var(--text2); cursor: pointer; transition: all .15s;
    }
    .dz:hover { border-color: var(--accent); color: var(--accent); }
    .dz input { display: none; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
      background: var(--green); color: #fff; border-radius: 8px;
      font-size: 13px; font-weight: 600; opacity: 0;
      transform: translateY(10px); transition: all .3s; z-index: 9999; pointer-events: none;
    }
    .toast.error { background: var(--red); }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* States */
    .loading, .empty {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; padding: 32px; color: var(--text2); gap: 8px; font-size: 13px;
    }
    .spin {
      width: 22px; height: 22px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: sp .7s linear infinite;
    }
    @keyframes sp { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="PoolManagerPage" data-role="page" class="page type-interior pluginConfigurationPage">
    <div data-role="content">
      <div class="content-primary pm">

        <!-- Header -->
        <div class="pm-head">
          <h1>Pool Manager</h1>
          <div class="pm-head-stats" id="pmStats"></div>
          <div class="pm-head-actions">
            <button class="btn btn-red btn-sm" id="pmCleanup">Orphelins</button>
            <a href="#!/configurationpage?name=Poster%20Rotator" class="btn btn-sm">Retour</a>
          </div>
        </div>

        <!-- Search -->
        <div class="pm-search">
          <input type="text" id="pmQ" placeholder="Rechercher..." />
          <div class="filters">
            <button class="fil on" data-f="">Tous</button>
            <button class="fil" data-f="Movie">Films</button>
            <button class="fil" data-f="Series">Series</button>
          </div>
        </div>

        <!-- List -->
        <div class="acc" id="pmList">
          <div class="loading"><div class="spin"></div>Chargement...</div>
        </div>

        <!-- Toast -->
        <div class="toast" id="pmToast"></div>
      </div>
    </div>

    <script type="text/javascript">
    (function () {
      'use strict';

      /* ── State ── */
      var pools = [];
      var openId = null;
      var typeFilter = '';

      /* ── DOM helpers ── */
      function el(id) { return document.getElementById(id); }
      function h(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

      /* ── Toast ── */
      var toastTimer = null;
      function toast(msg, isError) {
        var t = el('pmToast');
        t.textContent = msg;
        t.className = 'toast show' + (isError ? ' error' : '');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(function () { t.className = 'toast'; }, 2500);
      }

      /* ── API helper ── */
      function api(method, path, body) {
        return new Promise(function (ok, fail) {
          var opts = {
            type: method,
            url: ApiClient.getUrl(path),
            contentType: 'application/json'
          };
          if (body) opts.data = JSON.stringify(body);
          ApiClient.ajax(opts).then(function (resp) {
            if (typeof resp === 'string' && resp.length > 0) {
              try { ok(JSON.parse(resp)); } catch (e) { ok(resp); }
            } else {
              ok(resp);
            }
          }, fail);
        });
      }

      /* ── Stats ── */
      function loadStats() {
        api('GET', 'PosterRotator/Stats').then(function (s) {
          var warn = (s.OrphanedPools || s.orphanedPools || 0) > 0 ? ' warn' : '';
          var tp = s.TotalPools != null ? s.TotalPools : s.totalPools;
          var ti = s.TotalImages != null ? s.TotalImages : s.totalImages;
          var ts = s.TotalSizeFormatted || s.totalSizeFormatted || '0 B';
          var op = s.OrphanedPools != null ? s.OrphanedPools : s.orphanedPools;
          el('pmStats').innerHTML =
            '<span><b>' + (tp||0) + '</b> pools</span>' +
            '<span><b>' + (ti||0) + '</b> images</span>' +
            '<span><b>' + h(ts) + '</b></span>' +
            '<span class="' + warn + '"><b>' + (op||0) + '</b> orphelins</span>';
        }).catch(function () {
          el('pmStats').textContent = 'Erreur stats';
        });
      }

      /* ── Pool list ── */
      function loadPools() {
        api('GET', 'PosterRotator/Items').then(function (list) {
          pools = list || [];
          render();
        }).catch(function () {
          el('pmList').innerHTML = '<div class="empty">Impossible de charger les pools</div>';
        });
      }

      /* ── Prop helper (handles PascalCase + camelCase) ── */
      function P(o, pascal) {
        if (o == null) return undefined;
        if (o[pascal] !== undefined) return o[pascal];
        var camel = pascal.charAt(0).toLowerCase() + pascal.slice(1);
        return o[camel];
      }

      /* ── Health ── */
      function hpClass(n) { return n === 0 ? 'hp-empty' : n < 3 ? 'hp-low' : 'hp-ok'; }
      function hpLabel(n) { return n === 0 ? 'Vide' : n < 3 ? n + ' img' : n + ' img'; }

      /* ── Render accordion ── */
      function render() {
        var q = (el('pmQ').value || '').toLowerCase();
        var filtered = pools.filter(function (p) {
          var name = P(p, 'ItemName') || '';
          var type = P(p, 'ItemType') || '';
          return (!typeFilter || type === typeFilter) && (!q || name.toLowerCase().indexOf(q) >= 0);
        });

        if (!filtered.length) {
          el('pmList').innerHTML = '<div class="empty">Aucun pool trouvé</div>';
          return;
        }

        var out = '';
        for (var i = 0; i < filtered.length; i++) {
          var p = filtered[i];
          var id = P(p, 'ItemId');
          var name = P(p, 'ItemName') || '?';
          var type = P(p, 'ItemType') || 'Movie';
          var imgs = P(p, 'Images') || [];
          var size = P(p, 'TotalSizeFormatted') || '';
          var isOpen = openId === id;
          var n = imgs.length;
          var tl = type.toLowerCase();

          out += '<div class="acc-item' + (isOpen ? ' open' : '') + '" data-id="' + id + '">';
          out += '<div class="acc-head" data-id="' + id + '">';
          out += '<span class="acc-arrow">&#9654;</span>';
          out += '<span class="acc-name">' + h(name) + '</span>';
          out += '<div class="acc-meta">';
          out += '<span class="hp ' + hpClass(n) + '">' + hpLabel(n) + '</span>';
          out += '<span>' + h(size) + '</span>';
          out += '<span class="tp tp-' + tl + '">' + h(type) + '</span>';
          out += '</div></div>';
          out += '<div class="acc-body" id="body-' + id + '"></div>';
          out += '</div>';
        }

        el('pmList').innerHTML = out;

        // Bind headers
        var heads = document.querySelectorAll('.acc-head');
        for (var j = 0; j < heads.length; j++) {
          (function (header) {
            header.onclick = function () { toggle(header.getAttribute('data-id')); };
          })(heads[j]);
        }

        // Load open body
        if (openId) loadBody(openId);
      }

      function toggle(id) {
        openId = openId === id ? null : id;
        render();
      }

      /* ── Load expanded body ── */
      function loadBody(id) {
        var c = el('body-' + id);
        if (!c) return;
        c.innerHTML = '<div class="loading"><div class="spin"></div></div>';

        api('GET', 'PosterRotator/Pool/' + id).then(function (pool) {
          renderBody(c, pool);
        }).catch(function () {
          c.innerHTML = '<div class="empty">Erreur de chargement</div>';
        });
      }

      /* ── Render body content ── */
      function renderBody(c, pool) {
        var id = P(pool, 'ItemId');
        var imgs = P(pool, 'Images') || [];

        // Toolbar
        var out = '<div class="toolbar">';
        out += '<button class="btn btn-accent btn-sm" id="rot-' + id + '">&#128260; Rotation</button>';
        out += '</div>';

        // Grid
        if (!imgs.length) {
          out += '<div class="empty">Pool vide</div>';
        } else {
          out += '<div class="grid">';
          for (var i = 0; i < imgs.length; i++) {
            var img = imgs[i];
            var fn = P(img, 'FileName') || '';
            var url = P(img, 'Url') || '';
            var cur = P(img, 'IsCurrent');

            out += '<div class="card' + (cur ? ' active' : '') + '">';
            if (cur) out += '<div class="card-badge">Actif</div>';
            out += '<img src="' + ApiClient.getUrl(url) + '" loading="lazy" />';
            out += '<button class="card-del" data-fn="' + h(fn) + '" data-id="' + id + '">&#215;</button>';
            out += '</div>';
          }
          out += '</div>';
        }

        // Add zone
        out += '<div class="add-zone">';
        out += '<div class="add-tabs">';
        out += '<button class="add-tab on" data-t="search" data-id="' + id + '">Chercher</button>';
        out += '<button class="add-tab" data-t="upload" data-id="' + id + '">Importer</button>';
        out += '</div>';
        out += '<div class="add-body" id="ab-' + id + '"></div>';
        out += '</div>';

        c.innerHTML = out;

        // Bind rotate
        var rotBtn = el('rot-' + id);
        if (rotBtn) rotBtn.onclick = function () { doRotate(id); };

        // Bind delete buttons
        var dels = c.querySelectorAll('.card-del');
        for (var d = 0; d < dels.length; d++) {
          (function (btn) {
            btn.onclick = function (e) {
              e.stopPropagation();
              doDelete(btn.getAttribute('data-id'), btn.getAttribute('data-fn'));
            };
          })(dels[d]);
        }

        // Bind tabs
        var tabs = c.querySelectorAll('.add-tab');
        for (var t = 0; t < tabs.length; t++) {
          (function (tab) {
            tab.onclick = function () {
              var allTabs = c.querySelectorAll('.add-tab');
              for (var x = 0; x < allTabs.length; x++) allTabs[x].className = 'add-tab';
              tab.className = 'add-tab on';
              var tabId = tab.getAttribute('data-id');
              if (tab.getAttribute('data-t') === 'search') doSearch(tabId);
              else doUploadUI(tabId);
            };
          })(tabs[t]);
        }

        // Auto search
        doSearch(id);
      }

      /* ── Actions ── */
      function doRotate(id) {
        api('POST', 'PosterRotator/Pool/' + id + '/Rotate').then(function () {
          toast('Rotation effectuee');
          loadBody(id);
        }).catch(function () {
          toast('Echec de la rotation', true);
        });
      }

      function doDelete(id, fn) {
        if (!confirm('Supprimer ' + fn + ' ?')) return;
        api('DELETE', 'PosterRotator/Pool/' + id + '/' + encodeURIComponent(fn)).then(function () {
          toast('Image supprimee');
          loadBody(id);
          loadStats();
          loadPools();
        }).catch(function () {
          toast('Echec suppression', true);
        });
      }

      function doSearch(id) {
        var c = el('ab-' + id);
        if (!c) return;
        c.innerHTML = '<div class="loading"><div class="spin"></div></div>';

        api('GET', 'PosterRotator/Search/' + id).then(function (list) {
          if (!list || !list.length) {
            c.innerHTML = '<div class="empty">Aucune image trouvee</div>';
            return;
          }
          var out = '<div class="r-grid">';
          var max = Math.min(list.length, 20);
          for (var i = 0; i < max; i++) {
            var img = list[i];
            var u = P(img, 'Url') || P(img, 'url') || '';
            var tu = P(img, 'ThumbnailUrl') || P(img, 'thumbnailUrl') || u;
            out += '<div class="r-card" data-url="' + h(u) + '" data-id="' + id + '">';
            out += '<img src="' + h(tu) + '" loading="lazy" />';
            out += '<div class="r-plus">+</div>';
            out += '</div>';
          }
          out += '</div>';
          c.innerHTML = out;

          var cards = c.querySelectorAll('.r-card');
          for (var j = 0; j < cards.length; j++) {
            (function (card) {
              card.onclick = function () {
                doAddUrl(card.getAttribute('data-id'), card.getAttribute('data-url'));
              };
            })(cards[j]);
          }
        }).catch(function () {
          c.innerHTML = '<div class="empty">Erreur de recherche</div>';
        });
      }

      function doAddUrl(id, url) {
        api('POST', 'PosterRotator/Pool/' + id + '/AddFromUrl', { Url: url }).then(function () {
          toast('Image ajoutee');
          loadBody(id);
          loadStats();
        }).catch(function () {
          toast('Echec ajout', true);
        });
      }

      function doUploadUI(id) {
        var c = el('ab-' + id);
        if (!c) return;
        c.innerHTML =
          '<div class="dz" id="dz-' + id + '">' +
          'Glissez des images ici ou cliquez' +
          '<input type="file" id="fi-' + id + '" accept="image/*" multiple />' +
          '</div>';

        var dz = el('dz-' + id);
        var fi = el('fi-' + id);
        dz.onclick = function () { fi.click(); };
        fi.onchange = function () { doUpload(id, fi.files); };
        dz.ondragover = function (e) { e.preventDefault(); dz.style.borderColor = 'var(--accent)'; };
        dz.ondragleave = function () { dz.style.borderColor = ''; };
        dz.ondrop = function (e) { e.preventDefault(); dz.style.borderColor = ''; doUpload(id, e.dataTransfer.files); };
      }

      function doUpload(id, files) {
        if (!files || !files.length) return;
        var remaining = files.length;

        for (var i = 0; i < files.length; i++) {
          (function (file) {
            var fd = new FormData();
            fd.append('file', file);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', ApiClient.getUrl('PosterRotator/Pool/' + id));
            xhr.setRequestHeader('X-Emby-Token', ApiClient.accessToken());
            xhr.onload = function () {
              remaining--;
              if (remaining === 0) {
                toast(files.length + ' image(s) importee(s)');
                loadBody(id);
                loadStats();
                loadPools();
              }
            };
            xhr.onerror = function () {
              remaining--;
              toast('Erreur upload', true);
            };
            xhr.send(fd);
          })(files[i]);
        }
      }

      /* ── Filter & Search ── */
      el('pmQ').oninput = render;

      var filBtns = document.querySelectorAll('.fil');
      for (var f = 0; f < filBtns.length; f++) {
        (function (btn) {
          btn.onclick = function () {
            var all = document.querySelectorAll('.fil');
            for (var x = 0; x < all.length; x++) all[x].className = 'fil';
            btn.className = 'fil on';
            typeFilter = btn.getAttribute('data-f');
            render();
          };
        })(filBtns[f]);
      }

      /* ── Cleanup ── */
      el('pmCleanup').onclick = function () {
        if (!confirm('Supprimer les pools orphelins ?')) return;
        api('POST', 'PosterRotator/Cleanup').then(function (r) {
          var msg = P(r, 'Message') || P(r, 'message') || 'Nettoyage termine';
          toast(msg);
          loadStats();
          loadPools();
        }).catch(function () {
          toast('Echec nettoyage', true);
        });
      };

      /* ── Init: call immediately + on Jellyfin page events ── */
      function init() { loadStats(); loadPools(); }

      // Call init immediately
      init();

      // Also bind to Jellyfin page lifecycle events
      var page = el('PoolManagerPage');
      if (page) {
        page.addEventListener('viewshow', init);
        page.addEventListener('pageshow', init);
      }
    })();
    </script>
  </div>
</body>
</html>