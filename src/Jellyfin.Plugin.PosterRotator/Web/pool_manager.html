<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <title>Pool Manager</title>
    <style>
        /* Reset & Fonts */
        :root {
            --bg-dark: #101014;
            --bg-panel: #18181f;
            --bg-hover: #2a2a35;
            --accent: #00a4dc;
            --accent-hover: #008cc0;
            --text-main: #e5e5e5;
            --text-muted: #999;
            --border: #2a2a35;
            --danger: #dc2626;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* === LAYOUT === */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .stats-row {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .stat-val {
            color: var(--accent);
            font-weight: bold;
        }

        .stat-warn {
            color: #f59e0b;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Button Styles */
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-main);
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-hover);
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-danger {
            border-color: #7f1d1d;
            color: #f87171;
        }

        .btn-danger:hover {
            background: #7f1d1d;
            color: #fff;
        }

        /* Main Split View */
        .split-view {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* --- LEFT: Media List --- */
        .sidebar {
            width: 380px;
            background: #14141a;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .search-area {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: #0f0f12;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .filter-tabs {
            display: flex;
            padding: 10px 15px;
            gap: 10px;
            border-bottom: 1px solid var(--border);
        }

        .filter-tab {
            flex: 1;
            padding: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-muted);
            background: transparent;
            border: 1px solid transparent;
        }

        .filter-tab:hover {
            background: var(--bg-hover);
        }

        .filter-tab.active {
            background: var(--bg-hover);
            color: #fff;
            border-color: var(--border);
            font-weight: bold;
        }

        .media-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .media-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-left: 4px solid transparent;
        }

        .media-item:hover {
            background: var(--bg-hover);
        }

        .media-item.selected {
            background: #0d3a5c;
            /* Blueish background */
            border-left-color: var(--accent);
        }

        .media-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .media-item.selected .media-name {
            color: #fff;
        }

        .media-info {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .media-item.selected .media-info {
            color: #ccc;
        }

        .type-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--bg-hover);
            text-transform: uppercase;
        }

        /* --- RIGHT: Content --- */
        .content-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }

        .content-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 18px;
            font-weight: bold;
        }

        .content-subtitle {
            margin-left: 10px;
            font-weight: normal;
            font-size: 14px;
            color: var(--text-muted);
        }

        .images-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        /* Fixed Aspect Ratio Card */
        .img-card {
            position: relative;
            width: 100%;
            padding-bottom: 150%;
            /* 2:3 Ratio */
            background: #1a1a20;
            border-radius: 6px;
            overflow: hidden;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .img-card:hover {
            transform: scale(1.03);
            border-color: var(--accent);
        }

        .img-card.current {
            border-color: #22c55e;
        }

        .img-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Crucial for uniform look */
        }

        .img-status {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #22c55e;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .img-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .img-card:hover .img-delete {
            opacity: 1;
        }

        /* Bottom Panel (Search/Upload) */
        .bottom-panel {
            height: 250px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
        }

        .bottom-header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1a1a20;
        }

        .tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .tab-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .bottom-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .remote-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .remote-card {
            position: relative;
            width: 100%;
            padding-bottom: 150%;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .remote-card img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remote-card .add-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 164, 220, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .remote-card:hover .add-overlay {
            opacity: 1;
        }

        /* Upload Box */
        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-box:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: #0d3a5c20;
        }

        .upload-box input {
            display: none;
        }

        /* Loading/Empty */
        .state-msg {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            gap: 10px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="PoolManagerPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content" class="app-container">

            <!-- HEADER -->
            <div class="header">
                <h1>Pool Manager</h1>
                <div class="stats-row" id="stats">
                    <span>Chargement...</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-danger" id="btnCleanup">üóëÔ∏è Nettoyer orphelins</button>
                    <a href="#!/configurationpage?name=Poster%20Rotator" class="btn">‚Üê Retour</a>
                </div>
            </div>

            <!-- MAIN SPLIT -->
            <div class="split-view">

                <!-- SIDEBAR -->
                <div class="sidebar">
                    <div class="search-area">
                        <input type="text" class="search-input" id="search" placeholder="üîç Rechercher..." />
                    </div>
                    <div class="filter-tabs">
                        <button class="filter-tab active" data-f="">Tous</button>
                        <button class="filter-tab" data-f="Movie">Films</button>
                        <button class="filter-tab" data-f="Series">S√©ries</button>
                    </div>
                    <div class="media-list" id="list">
                        <div class="state-msg">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- CONTENT -->
                <div class="content-panel">
                    <div class="content-header">
                        <div id="titleContainer">
                            <span class="content-title" id="titleMain">S√©lectionnez un m√©dia</span>
                            <span class="content-subtitle" id="titleSub">pour voir ses images</span>
                        </div>
                        <button class="btn btn-primary" id="btnRefresh" style="display:none;">‚Üª Actualiser</button>
                    </div>

                    <div class="images-grid-container" id="imagesArea">
                        <div class="state-msg">üëà S√©lectionnez un √©l√©ment dans la liste</div>
                    </div>

                    <!-- BOTTOM PANEL -->
                    <div class="bottom-panel" id="bottomPanel" style="display:none;">
                        <div class="bottom-header">
                            <div class="tabs">
                                <button class="tab-btn active" data-tab="search">üîç Rechercher images</button>
                                <button class="tab-btn" data-tab="upload">üì§ Upload manuel</button>
                            </div>
                            <button class="btn" id="btnCloseBottom">‚úï Fermer</button>
                        </div>
                        <div class="bottom-content" id="bottomContent"></div>
                    </div>
                </div>

            </div>

        </div>

        <!-- SCRIPT -->
        <script type="text/javascript">
            (function () {
                var pools = [], selId = null, filter = '', tab = 'search';
                var $ = function (id) { return document.getElementById(id); };
                var esc = function (s) { var d = document.createElement('div'); d.innerText = s || ''; return d.innerHTML; };

                function api(m, u, d) {
                    return new Promise((res, rej) => {
                        ApiClient.ajax({
                            type: m,
                            url: ApiClient.getUrl(u),
                            data: d ? JSON.stringify(d) : null,
                            contentType: 'application/json',
                            dataType: 'json'
                        }).then(res, rej);
                    });
                }

                function renderStats(s) {
                    var h = '';
                    h += '<span class="stat-val">' + (s.TotalPools || 0) + '</span> pools &nbsp;‚Ä¢&nbsp; ';
                    h += '<span class="stat-val">' + (s.TotalImages || 0) + '</span> images &nbsp;‚Ä¢&nbsp; ';
                    h += '<span>' + (s.TotalSizeFormatted || '0 B') + '</span> &nbsp;‚Ä¢&nbsp; ';
                    var warn = s.OrphanedPools > 0 ? 'stat-warn' : 'stat-val';
                    h += '<span class="' + warn + '">' + (s.OrphanedPools || 0) + '</span> orphelins';
                    $('stats').innerHTML = h;
                }

                function loadAll() {
                    api('GET', 'PosterRotator/Stats').then(renderStats);
                    api('GET', 'PosterRotator/Items').then(function (p) {
                        pools = p || [];
                        renderList();
                    });
                }

                function renderList() {
                    var q = ($('search').value || '').toLowerCase();
                    var f = pools.filter(function (p) {
                        return (!filter || p.ItemType === filter) && (!q || p.ItemName.toLowerCase().indexOf(q) >= 0);
                    });

                    if (!f.length) {
                        $('list').innerHTML = '<div class="state-msg">Aucun r√©sultat</div>';
                        return;
                    }

                    var h = '';
                    f.forEach(function (p) {
                        var sel = p.ItemId === selId ? ' selected' : '';
                        var cnt = p.Images ? p.Images.length : 0;
                        h += '<div class="media-item' + sel + '" data-id="' + p.ItemId + '">';
                        h += '<div class="media-name"><span>' + esc(p.ItemName) + '</span> <span class="type-badge">' + esc(p.ItemType) + '</span></div>';
                        h += '<div class="media-info"><span>' + cnt + ' images</span> <span>' + esc(p.TotalSizeFormatted) + '</span></div>';
                        h += '</div>';
                    });
                    $('list').innerHTML = h;

                    document.querySelectorAll('.media-item').forEach(function (el) {
                        el.onclick = function () { select(el.dataset.id); };
                    });
                }

                function select(id) {
                    selId = id;
                    renderList();
                    loadPool(id);
                    $('bottomPanel').style.display = 'flex';
                    $('btnRefresh').style.display = 'inline-flex';
                    renderBottom();
                }

                function loadPool(id) {
                    $('imagesArea').innerHTML = '<div class="state-msg"><div class="spinner"></div></div>';
                    api('GET', 'PosterRotator/Pool/' + id).then(function (p) {
                        $('titleMain').textContent = p.ItemName;
                        $('titleSub').textContent = (p.Images ? p.Images.length : 0) + ' images dans le pool';

                        if (!p.Images || !p.Images.length) {
                            $('imagesArea').innerHTML = '<div class="state-msg">Le pool est vide</div>';
                            return;
                        }

                        var h = '<div class="images-grid">';
                        p.Images.forEach(function (img) {
                            var cur = img.IsCurrent ? ' current' : '';
                            var url = ApiClient.getUrl(img.Url) + '&v=' + Date.now(); // Cache bust
                            h += '<div class="img-card' + cur + '">';
                            h += '<img src="' + url + '" loading="lazy"/>';
                            if (img.IsCurrent) h += '<div class="img-status">ACTIF</div>';
                            h += '<button class="img-delete" data-f="' + esc(img.FileName) + '">√ó</button>';
                            h += '</div>';
                        });
                        h += '</div>';
                        $('imagesArea').innerHTML = h;

                        document.querySelectorAll('.img-delete').forEach(function (b) {
                            b.onclick = function (e) { e.stopPropagation(); del(b.dataset.f); };
                        });
                    });
                }

                function del(f) {
                    if (!confirm('Supprimer cette image ?')) return;
                    api('DELETE', 'PosterRotator/Pool/' + selId + '/' + encodeURIComponent(f)).then(refresh);
                }

                function refresh() {
                    loadPool(selId);
                    loadAll();
                }

                function renderBottom() {
                    if (tab === 'search') {
                        $('bottomContent').innerHTML = '<div class="state-msg"><div class="spinner"></div>Recherche...</div>';
                        api('GET', 'PosterRotator/Search/' + selId).then(function (imgs) {
                            if (!imgs || !imgs.length) {
                                $('bottomContent').innerHTML = '<div class="state-msg">Aucune image trouv√©e via les providers</div>';
                                return;
                            }
                            var h = '<div class="remote-grid">';
                            imgs.slice(0, 30).forEach(function (i) {
                                h += '<div class="remote-card" data-url="' + esc(i.Url) + '">';
                                h += '<img src="' + esc(i.ThumbnailUrl || i.Url) + '" loading="lazy" />';
                                h += '<div class="add-overlay">+</div>';
                                h += '</div>';
                            });
                            h += '</div>';
                            $('bottomContent').innerHTML = h;
                            document.querySelectorAll('.remote-card').forEach(function (el) {
                                el.onclick = function () { addUrl(el.dataset.url); };
                            });
                        });
                    } else {
                        var h = '<div class="upload-box" id="dropzone">';
                        h += '<div style="font-size:32px;margin-bottom:10px">üì§</div>';
                        h += 'Glissez des images ici ou cliquez pour parcourir';
                        h += '<input type="file" id="fileinput" multiple accept="image/*" />';
                        h += '</div>';
                        $('bottomContent').innerHTML = h;

                        var dz = $('dropzone'), fi = $('fileinput');
                        dz.onclick = function () { fi.click(); };
                        fi.onchange = function () { upload(fi.files); };
                        dz.ondragover = function (e) { e.preventDefault(); };
                        dz.ondrop = function (e) { e.preventDefault(); upload(e.dataTransfer.files); };
                    }
                }

                function addUrl(url) {
                    api('POST', 'PosterRotator/Pool/' + selId + '/AddFromUrl', { Url: url }).then(refresh);
                }

                function upload(files) {
                    if (!files.length) return;
                    var pending = files.length;
                    Array.from(files).forEach(function (f) {
                        var fd = new FormData(); fd.append('file', f);
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', ApiClient.getUrl('PosterRotator/Pool/' + selId));
                        xhr.setRequestHeader('X-Emby-Token', ApiClient.accessToken());
                        xhr.onload = function () { if (--pending === 0) refresh(); };
                        xhr.send(fd);
                    });
                }

                // Binds
                $('search').oninput = renderList;
                document.querySelectorAll('.filter-tab').forEach(function (b) {
                    b.onclick = function () {
                        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                        b.classList.add('active');
                        filter = b.dataset.f;
                        renderList();
                    };
                });
                document.querySelectorAll('.tab-btn').forEach(function (b) {
                    b.onclick = function () {
                        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                        b.classList.add('active');
                        tab = b.dataset.tab;
                        renderBottom();
                    };
                });
                $('btnCloseBottom').onclick = function () { $('bottomPanel').style.display = 'none'; };
                $('btnRefresh').onclick = refresh;
                $('btnCleanup').onclick = function () {
                    if (confirm('Nettoyer les pools orphelins ?')) api('POST', 'PosterRotator/Cleanup').then(alert('Nettoyage termin√©')).then(loadAll);
                };

                // Init
                $('PoolManagerPage').addEventListener('pageshow', loadAll);
            })();
        </script>
    </div>
</body>

</html>